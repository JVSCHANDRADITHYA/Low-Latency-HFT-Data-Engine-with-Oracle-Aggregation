<!DOCTYPE html>
<html>
<head>
  <title>Oracle Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
      padding: 20px;
    }
    .card {
      background: #1e293b;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .green { color: #22c55e; }
    .red { color: #ef4444; }
    canvas {
      width: 100% !important;
      height: 300px !important;
    }
  </style>
</head>
<body>

  <h1>ðŸ“Š Oracle Manager Dashboard</h1>

  <div class="card">
    <h2>BTC Price</h2>
    <h1 id="btc-price">Loading...</h1>
  </div>

  <div class="card">
    <h2>Oracle Health</h2>
    <h3 id="health-status">Loading...</h3>
  </div>

  <div class="card">
    <h2>BTC Price History</h2>
    <canvas id="btcChart"></canvas>
  </div>

  <script>
    const priceEl = document.getElementById("btc-price");
    const healthEl = document.getElementById("health-status");

    const ctx = document.getElementById("btcChart").getContext("2d");

    const btcChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "BTC Price",
          data: [],
          borderColor: "#38bdf8",
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    async function refreshData() {
      try {
        // âœ… Current Price (RELATIVE URL = NO CORS ISSUE)
        const priceRes = await fetch("/oracle/price/BTC");
        const priceData = await priceRes.json();

        if (priceData.price) {
          priceEl.innerText = `$${priceData.price.toFixed(2)}`;
        } else {
          priceEl.innerText = "Waiting for price...";
        }

        // âœ… Health
        const healthRes = await fetch("/oracle/health");
        const healthData = await healthRes.json();

        healthEl.innerText = (healthData.status || "unknown").toUpperCase();
        healthEl.className = healthData.status === "healthy" ? "green" : "red";

        // âœ… History
        const historyRes = await fetch("/oracle/history/BTC");
        const historyData = await historyRes.json();

        if (Array.isArray(historyData)) {
          const prices = historyData.map(x => x.price).reverse();
          const labels = historyData
            .map(x => new Date(x.timestamp * 1000).toLocaleTimeString())
            .reverse();

          btcChart.data.labels = labels;
          btcChart.data.datasets[0].data = prices;
          btcChart.update();
        }

      } catch (err) {
        console.error("Dashboard error:", err);
        priceEl.innerText = "Backend not reachable";
        healthEl.innerText = "ERROR";
        healthEl.className = "red";
      }
    }

    refreshData();
    setInterval(refreshData, 2000);
  </script>

</body>
</html>
